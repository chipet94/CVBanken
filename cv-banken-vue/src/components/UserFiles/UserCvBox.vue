<template>
  <section class="container">
    <div class="title is-6">CV</div>
    <b-field v-if="!user.cv && canEdit" :class="{'has-name': !!file}" class="file is-primary">
      <b-upload v-model="file" accept="" class="file-label">
            <span class="file-cta">
                <b-icon class="file-icon" icon="select"></b-icon>
                <span class="file-label">Välj fil</span>
            </span>
        <span v-if="file" class="file-name">
                {{ file.name }}
          <button class="delete is-small has-background-danger"
                  type="button"
                  @click="file = null">
          </button>
            </span>
      </b-upload>
      <b-button v-if="file" class="ITHS-button-small" @click="UploadCv">
        <span class="is-horizontal">

          <b-icon class="file-icon" icon="upload"></b-icon>
        </span>


      </b-button>
    </b-field>
    <div v-if="user.cv" class="columns">
      <div class="column">
        {{ user.cv.name }}
      </div>
      <div class="column">
        {{ user.cv.uploaded }}
      </div>
      <div class="column">
        <b-button v-if="canEdit" class="is-danger" @click="Remove">
          <b-icon class="file-icon" icon="delete"></b-icon>
        </b-button>
        <b-button class="ITHS-button-small" @click="handleDownload">
          <b-icon class="file-icon" icon="download"></b-icon>
        </b-button>

      </div>
    </div>
  </section>
</template>

<script>
export default {
  name: "UserCvBox",
  props: {user: {}, canEdit: Boolean},
  data() {
    return {
      file: null
    }
  },
  methods: {
    async UploadCv() {
      let formData = new FormData();
      formData.append('file', this.file);
      await this.$store.dispatch("files/SetCV", formData).then(
          res => {
            console.log(res)
            this.$store.dispatch("profile/getByUrl", this.user.url).then(console.log("updated"))
            this.$buefy.toast.open({
              message: 'CV uppladdat!',
              type: 'is-success'
            })

            // alert("Success! Dina filer är nu uppladdade!")
          }
      ).catch(err => {

        this.loading = false;
        this.$buefy.toast.open({
          message: err.response.data,
          type: 'is-danger'
        })
        console.log(err)
      })
    },
    StartDownload(response, filename) {
      const url = window.URL.createObjectURL(new Blob([response]))
      const downloadLink = document.createElement('a')
      downloadLink.href = url
      downloadLink.setAttribute('download', filename) //or any other extension
      document.body.appendChild(downloadLink)
      downloadLink.click()
    },
    async handleDownload() {
      await this.$store.dispatch("files/downloadCv", this.user.cv.id).then(
          res => {
            this.StartDownload(res, this.user.cv.name)
          }
      ).catch(() => {
        this.$buefy.toast.open({
          message: "Något gick fel, gick inte att hämta...",
          type: 'is-danger'
        })
      })

    },
    async Remove() {
      let confirmed = confirm("Remove file '" + this.user.cv.name + "'?")
      if (confirmed) {
        await this.$store.dispatch("files/removeCv", this.user.cv.id).then(
            res => {
              //this.getFiles();
              this.user.cv = null
              console.log(res)
            }
        ).catch(err => {
          console.log(err)
          this.$buefy.toast.open({
            message: "Något gick fel, gick inte att hämta...",
            type: 'is-danger'
          })
        })
      }
    },
  }
}
</script>

<style scoped>
.ITHS-button-small {
  background-color: #693250;
  color: white;
  font-weight: bold;
}

</style>